#ERC evolutionary rate calculation for nuclear and mt OXPHOS genes
#mito
/work/cyu/poolseq/PPalign_output/ann/*_fixed.sync



#################### 0. ç”Ÿæˆ POPS æ•°ç»„ ####################
BAMLIST=/work/cyu/poolseq/PPalign_output/mtDNA_bam/bamlist.txt   # â† mtDNA bamlist

# ä»è·¯å¾„ä¸­æŠ½å‡ºæ ·æœ¬ IDï¼Œé¡ºåºä¸ bamlist å®Œå…¨ä¸€è‡´
POPS=($(awk -F'/' '{sub(/_mtDNA\.bam$/,"",$NF); print $NF}' "$BAMLIST"))

echo "æ£€æµ‹åˆ° ${#POPS[@]} ä¸ªç§ç¾¤ï¼š"
echo "${POPS[@]}"
# ç¡®è®¤è¾“å‡ºåº”ä¸ºï¼š10_THE 11_JOE â€¦ 9_SWA  å…± 27 ä¸ª

#################### 1. sync â†’ cf æ‰¹é‡è½¬æ¢ ####################
SYNC_DIR=/work/cyu/poolseq/PPalign_output/ann         # ä½ çš„ 13 mt åŸºå›  sync ç›®å½•
CF_DIR=/mnt/spareHD_2/mt_gene_tree/counts
mkdir -p "$CF_DIR"

# 13 ä¸ª mt åŸºå› åï¼ˆæŒ‰ä½ çš„å‘½åï¼‰
GENES=(ND1 ND2 COX1 COX2 ATP8 ATP6 COX3 ND3 ND4L ND4 ND5 ND6 CYTB)

for GENE in "${GENES[@]}"; do
  S="$SYNC_DIR/${GENE}_fixed.sync"
  [[ -s "$S" ]] || { echo "âš  è·³è¿‡ç©ºæ–‡ä»¶ $S"; continue; }

  python /mnt/spareHD_2/mt_gene_tree/counts/1.py \
         "$S" "$CF_DIR/${GENE}.cf" "${POPS[@]}"
done

echo "âœ… counts(.cf) å†™å…¥ $CF_DIR"


#n=2
#!/usr/bin/env bash
set -euo pipefail

#################### 0) ç‰©ç§é¡ºåºï¼ˆæŒ‰ bamlistï¼‰ ####################
BAMLIST=/work/cyu/poolseq/PPalign_output/mtDNA_bam/bamlist.txt
# æå–æ ·æœ¬ IDï¼ˆå»æ‰ _mtDNA.bamï¼‰ï¼Œé¡ºåºä¸ bamlist å®Œå…¨ä¸€è‡´
readarray -t POPS < <(awk -F'/' '{sub(/_mtDNA\.bam$/,"",$NF); print $NF}' "$BAMLIST")

echo "æ£€æµ‹åˆ° ${#POPS[@]} ä¸ªç§ç¾¤ï¼š"
echo "${POPS[@]}"
echo

#################### 1) sync â†’ cf æ‰¹é‡è½¬æ¢ ####################
SYNC_DIR=/work/cyu/poolseq/PPalign_output/ann
CF_DIR=/mnt/spareHD_2/mt_gene_tree/counts_top1
SCRIPT=/mnt/spareHD_2/mt_gene_tree/counts/sync2cf_pomo_fix.py  # è§ä¸‹æ–¹ Python
TOPN=1   # â† æŒ‰ä½ çš„è¦æ±‚ï¼šæ¯ä¸ªä½ç‚¹ä¿ç•™å‰ 2 ä¸ªç­‰ä½

mkdir -p "$CF_DIR"

GENES=(ND1 ND2 COX1 COX2 ATP8 ATP6 COX3 ND3 ND4L ND4 ND5 ND6 CYTB)

for GENE in "${GENES[@]}"; do
  S="$SYNC_DIR/${GENE}_fixed.sync"
  O="$CF_DIR/${GENE}.cf"

  if [[ ! -s "$S" ]]; then
    echo "âš  è·³è¿‡ï¼šæ‰¾ä¸åˆ°æˆ–ç©ºæ–‡ä»¶ $S"
    continue
  fi

  echo "ğŸ”„ ç”Ÿæˆ CFï¼š$GENE"
  python "$SCRIPT" "$S" "$O" "${POPS[@]}" --topN "$TOPN"

  # è¯»å– CF å¤´ä¸€è¡Œæ‰“å° NSITES
  if [[ -s "$O" ]]; then
    NSITES=$(awk 'NR==1{for(i=1;i<=NF;i++) if($i=="NSITES"){print $(i+1); exit}}' "$O")
    echo "âœ… counts(.cf) å†™å…¥ $CF_DIR ï¼ˆNSITES=${NSITES:-0}ï¼‰ â†’ $O"
  else
    echo "â— ç”Ÿæˆå¤±è´¥ï¼š$O ä¸ºç©º"
  fi
done



#prune tree use nuclear topology

#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"  # å›ºå®šæ‹“æ‰‘
CF_DIR="/mnt/spareHD_2/mt_gene_tree/counts"                      # mtDNA CF ç›®å½•
OUT_DIR="/mnt/spareHD_2/mt_gene_tree/pruned_trees"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§å
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» CF æå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa

    NUM_TAXA=$(wc -l < /tmp/keep.taxa)
    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # å›ºå®š topology é‡æ–°ä¼° branch length
    iqtree2 -s "$CF" \
            -m GTR+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            --safe \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰ mtDNA åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"






MT_LIST=/work/cyu/poolseq/PPalign_output/mtDNA_bam/bamlist.txt
NUC_DIR=/mnt/spareHD_2/nuclear_with_readgroups_subset
OUT_LIST=/mnt/spareHD_2/oxphos_gene_tree/bamlist_nuclear.txt

awk -v d="$NUC_DIR" '
  # æ¯è¡Œå½¢å¦‚ .../10_THE_mtDNA.bam â†’ å– 10_THE
  {
    n = match($0, /([0-9]+_[A-Z]+)/, a)
    sid = a[1]                               # 10_THE
    print d "/" sid "_subset.bam"
  }
' "$MT_LIST" > "$OUT_LIST"


#!/usr/bin/env bash
set -euo pipefail                      # å‡ºé”™å³åœï¼Œæœªå®šä¹‰å˜é‡å³æŠ¥é”™

#####################  è·¯å¾„é…ç½®  #####################
REF=/work/cyu/stickleback_nuclear_only.fa.gz                # å‚è€ƒåŸºå› ç»„ï¼ˆå·² bgzip+faidxï¼‰
MT_BAMLIST=/work/cyu/poolseq/PPalign_output/mtDNA_bam/bamlist.txt
NUC_DIR=/mnt/spareHD_2/nuclear_with_readgroups_subset       # *_subset.bam
BEDDIR=/mnt/spareHD_2/oxphos_gene_tree/beds                 # æ¯åŸºå›  .bed
OUT=/mnt/spareHD_2/oxphos_gene_tree                         # è¾“å‡ºç›®å½•
THREADS=8                                                   # å½“å‰ samtools ç‰ˆæœ¬ä¸æ”¯æŒ -@ï¼Œä»…ç•™ä½œè®°å½•
############################################################

mkdir -p "$OUT"/{mpileup,beds}

#####################  1. ç”Ÿæˆæ ¸ bamlistï¼Œä¿æŒä¸ mtDNA é¡ºåºä¸€è‡´  #####################
BAMLIST_NUC=$OUT/bamlist_nuclear.txt
awk -v d="$NUC_DIR" '
  {
    match($0, /([0-9]+_[A-Z]+)/, a);        # æå–æ ·æœ¬ IDï¼ˆå¦‚ 10_THEï¼‰
    file=d"/"a[1]"_subset.bam";
    if (system("[ -f "file" ]")==0) print file;    # æ ¸ BAM å­˜åœ¨æ‰å†™
    else {
        printf("âš ï¸  Warning: %s ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡\n", file) > "/dev/stderr"
    }
  }' "$MT_BAMLIST" > "$BAMLIST_NUC"

echo "ğŸ“„  æ ¸ bamlist å†™å…¥ $(wc -l < "$BAMLIST_NUC") æ¡è·¯å¾„ â†’ $BAMLIST_NUC"

#####################  2. é€åŸºå›  mpileupï¼ˆå‚æ•°ä¸ç¤ºä¾‹ä¿æŒä¸€è‡´ï¼‰  #####################
for BED in "$BEDDIR"/*.bed; do
    GENE=$(basename "$BED" .bed)
    echo "ğŸ§¬  mpileup  $GENE"

    samtools mpileup \
        -B \
        -f "$REF" \
        -b "$BAMLIST_NUC" \
        -q 30 \
        -Q 30 \
        -d 5000 \
        -l "$BED" \
      | gzip > "$OUT/mpileup/${GENE}.mpileup.gz"
done

echo -e "\nğŸ‰  mpileup.gz æ–‡ä»¶å…¨éƒ¨å†™å…¥ï¼š$OUT/mpileup/"

cd /mnt/spareHD_2/oxphos_gene_tree/mpileup
gunzip *.mpileup.gz           # ä¸²è¡Œ
# æˆ–å¹¶è¡Œ
ls *.mpileup.gz | xargs -n1 -P8 gunzip




#mileup to sync
MP_DIR=/mnt/spareHD_2/oxphos_gene_tree/mpileup
SYNC_DIR=/mnt/spareHD_2/oxphos_gene_tree/sync
mkdir -p "$SYNC_DIR"

for MP in "$MP_DIR"/*.mpileup; do
  GENE=$(basename "$MP" .mpileup)
  perl mpileup2sync.pl \
       --input "$MP" \
       --output "$SYNC_DIR/${GENE}.sync" \
       --fastq-type sanger \
       --min-qual 30
done

#create cf files then iqtree
BAMLIST=/mnt/spareHD_2/oxphos_gene_tree/bamlist_nuclear.txt
# æŠŠè·¯å¾„å‰ªæˆæ ·æœ¬ IDï¼Œä¾‹å¦‚ 10_THE
POPS=($(awk -F'/' '{sub(/_subset\.bam$/,"",$NF); print $NF}' "$BAMLIST"))
echo "${#POPS[@]} pops: ${POPS[@]}"

#!/usr/bin/env python3
import sys, pathlib

sync, cf, *pops = sys.argv[1:]
with open(sync) as f, open(cf, "w") as o:
    lines=[l.split() for l in f]
    o.write(f"COUNTSFILE NPOP {len(pops)} NSITES {len(lines)}\n")
    o.write("CHROM  POS  " + "  ".join(pops) + "\n")
    for chrom,pos,ref,*cols in lines:
        row=[]
        for c in cols:                       # A:C:G:T:N:Indel
            a,cg,g,t,_,_ = map(int,c.split(':'))
            row.append(f"{a},{cg},{g},{t}")
        o.write(f"{chrom}  {pos}  " + "  ".join(row) + "\n")


#################### 0. ç”Ÿæˆ POPS æ•°ç»„ ####################
BAMLIST=/mnt/spareHD_2/oxphos_gene_tree/bamlist_nuclear.txt   # â† æ ¸ bamlist
# ä»è·¯å¾„ä¸­æŠ½å‡ºæ ·æœ¬ IDï¼Œé¡ºåºä¸ bamlist å®Œå…¨ä¸€è‡´
POPS=($(awk -F'/' '{sub(/_subset\.bam$/,"",$NF); print $NF}' "$BAMLIST"))

echo "æ£€æµ‹åˆ° ${#POPS[@]} ä¸ªç§ç¾¤ï¼š"
echo "${POPS[@]}"
# ç¡®è®¤è¾“å‡ºåº”ä¸ºï¼š10_THE 11_JOE â€¦ 9_SWA  å…± 27 ä¸ª

#################### 1. sync â†’ cf æ‰¹é‡è½¬æ¢ ####################
SYNC_DIR=/mnt/spareHD_2/oxphos_gene_tree/sync
CF_DIR=/mnt/spareHD_2/oxphos_gene_tree/counts
mkdir -p "$CF_DIR"

for S in "$SYNC_DIR"/*.sync; do
  [[ -s "$S" ]] || { echo "âš   è·³è¿‡ç©ºæ–‡ä»¶ $S"; continue; }
  GENE=$(basename "$S" .sync)

  python /path/to/sync2cf.py  \
         "$S"  "$CF_DIR/${GENE}.cf"  "${POPS[@]}"
done
echo "âœ… counts(.cf) å†™å…¥ $CF_DIR"



#iqtree
#!/usr/bin/env bash
set -euo pipefail

# -----------  è·¯å¾„ ------------
CF_DIR=/mnt/spareHD_2/oxphos_gene_tree/counts   # ä½ çš„ .cf æ–‡ä»¶ç›®å½•
TREE_DIR=/mnt/spareHD_2/oxphos_gene_tree/trees  # è¾“å‡ºç›®å½•
mkdir -p "$TREE_DIR"

THREADS=AUTO      # AUTO = IQ-TREE è‡ªåŠ¨æ£€æµ‹ï¼›ä¹Ÿå¯å†™ 16ã€32 ç­‰
BOOT=1000         # Ultrafast bootstrap è½®æ•°
ALRT=1000         # SH-aLRT è½®æ•°

# -----------  å¾ªç¯è·‘ -----------
for CF in "$CF_DIR"/*.cf; do
  GENE=$(basename "$CF" .cf)
  echo "ğŸŒ³  IQ-Tree  $GENE  ($(date +%T))"

  iqtree2 -s "$CF" \
          -m GTR+P \
          -nt "$THREADS" \
          -B "$BOOT" \
          -alrt "$ALRT" \
          -pre "$TREE_DIR/$GENE" \
          -quiet
done

echo -e "\nâœ…  æ‰€æœ‰åŸºå› æ ‘å®Œæˆï¼æ ‘æ–‡ä»¶åœ¨ï¼š$TREE_DIR/*.treefile"

#æ„å»ºmasteræ ‘ ç”¨nuclear oxpho 82genetree
java -Xmx8g -jar astral.5.7.8.jar \
  -i /mnt/spareHD_2/oxphos_gene_tree/genes_astral.tre \
  -o /mnt/spareHD_2/oxphos_gene_tree/species_astral.tre \
  2> /mnt/spareHD_2/oxphos_gene_tree/astral.log
astral.5.7.8.jar 
cat /mnt/spareHD_2/oxphos_gene_tree/species_astral.tre
(10_THE,(16_AMO,(((9_SWA,(11_JOE,12_BEA)0.49:0.052704063490568435)0.86:0.12852164098344246,((13_MUC,(22_FRED,24_PACH)1:0.7981770630522537)0.74:0.09167667908034977,((27_LB,(17_SAY,(28_CH,(25_RS,26_SC)1:0.4418327522790392)1:1.0091776080159818)0.68:0.16080153569716776)0.98:0.22450967855654755,((4_SL,(8_WK,7_WT)0.92:0.15588829972579915)0.44:0.02734415112952233,((5_TL,3_SR)0.64:0.06916681982473395,(2_LG,(1_FG,6_WB)0.98:0.20763936477824518)0.51:0.03889609052423365)0.49:0.04632609721427273)0.83:0.12022862571625097)0.5:0.03645182279797124)0.5:0.03708014865417043)0.44:0.022098788242902498,((14_PYE,19_ROB)0.66:0.07594115323538288,(23_LAW,((18_GOS,21_ECHO)0.97:0.2709576295105863,20_BOOT)1:0.8748478121554343)1:0.5341491814983622)0.38:0.007488021780721204)0.49:0.03425810992000614):0.0);


#using master tree prune gene tree
#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"
CF_DIR="/mnt/spareHD_2/oxphos_gene_tree/counts"
OUT_DIR="/mnt/spareHD_2/oxphos_gene_tree/pruned_trees"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§åï¼ˆå»æ‰åˆ†æ”¯é•¿åº¦å’Œæ”¯æŒå€¼ï¼‰
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» .cf æ–‡ä»¶ç¬¬2è¡Œæå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa

    NUM_TAXA=$(wc -l < /tmp/keep.taxa)
    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # ç”¨ IQ-TREE å›ºå®š topology é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦
    iqtree2 -s "$CF" \
            -m GTR+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            --safe \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"

#add gene name to the tre file and combine treefiles
cd /mnt/spareHD_2/oxphos_gene_tree/pruned_trees

for f in $(ls *_fixed.treefile | sort); do
    gene=${f%%_*}   # æ–‡ä»¶åå‰ç¼€ä¸º gene å
    echo "[$gene]"  # è¿™æ˜¯æ³¨é‡Šè¡Œ
    cat "$f"
done > /mnt/spareHD_2/oxphos_gene_tree/genes_astral_named.tre

treefile = "/users/changyueyu/desktop/genes_astral_named.tre"

outputfile = "/users/changyueyu/desktop/out.RDS"





#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"
CF_DIR="/mnt/spareHD_2/mt_gene_tree/counts_top2"
OUT_DIR="/mnt/spareHD_2/mt_gene_tree/pruned_trees_top2"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§å
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» .cf æ–‡ä»¶å¤´æå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa
    NUM_TAXA=$(wc -l < /tmp/keep.taxa)

    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # å›ºå®šæ‹“æ‰‘ï¼ŒPoMo æ¨¡å‹ï¼Œé‡æ–°ä¼° branch length
    iqtree2 -s "$CF" \
            -m GTR+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            --safe \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"



#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"
CF_DIR="/mnt/spareHD_2/mt_gene_tree/counts"
OUT_DIR="/mnt/spareHD_2/mt_gene_tree/pruned_trees"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§å
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» .cf æ–‡ä»¶å¤´æå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa
    NUM_TAXA=$(wc -l < /tmp/keep.taxa)

    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # å›ºå®šæ‹“æ‰‘ï¼ŒPoMo æ¨¡å‹ï¼Œé‡æ–°ä¼° branch length
    iqtree2 -s "$CF" \
            -m HKY+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            --safe \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"



#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"
CF_DIR="/mnt/spareHD_2/mt_gene_tree/counts"
OUT_DIR="/mnt/spareHD_2/mt_gene_tree/pruned_trees"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§å
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» .cf æ–‡ä»¶å¤´æå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa
    NUM_TAXA=$(wc -l < /tmp/keep.taxa)

    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # å›ºå®šæ‹“æ‰‘ï¼ŒPoMo æ¨¡å‹ï¼Œé‡æ–°ä¼° branch length
    iqtree2 -s "$CF" \
            -m GTR+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            -blmin 1e-12 -blmax 100 \
            --pomo-min-sample 1 --pomo-min-freq 0 \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"


#using master tree prune gene tree
#!/usr/bin/env bash
set -euo pipefail

MASTER_TRE="/mnt/spareHD_2/oxphos_gene_tree/species_astral.tre"
CF_DIR="/mnt/spareHD_2/mt_gene_tree/counts"
OUT_DIR="/mnt/spareHD_2/mt_gene_tree/pruned_trees"
THREADS=8

mkdir -p "$OUT_DIR"

# æå– master tree ç‰©ç§åï¼ˆå»æ‰åˆ†æ”¯é•¿åº¦å’Œæ”¯æŒå€¼ï¼‰
tr '(),:;' '\n' < "$MASTER_TRE" | grep -vE '^$|^[0-9.]+$' | sort -u > /tmp/master.tips

for CF in "$CF_DIR"/*.cf; do
    GENE=$(basename "$CF" .cf)
    echo "ğŸŒ¿ å¤„ç† $GENE ..."

    # ä» .cf æ–‡ä»¶ç¬¬2è¡Œæå–ç‰©ç§å
    awk 'NR==2 && $1=="CHROM"{for(i=3;i<=NF;i++) print $i}' "$CF" | sort -u > /tmp/cf.taxa

    # å–äº¤é›†
    comm -12 /tmp/master.tips /tmp/cf.taxa > /tmp/keep.taxa

    NUM_TAXA=$(wc -l < /tmp/keep.taxa)
    if (( NUM_TAXA < 4 )); then
        echo "âš ï¸  $GENE ç‰©ç§æ•°å¤ªå°‘ ($NUM_TAXA)ï¼Œè·³è¿‡"
        continue
    fi

    # ç”¨ IQ-TREE å›ºå®š topology é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦
    iqtree2 -s "$CF" \
            -m GTR+P \
            -g "$MASTER_TRE" \
            -nt "$THREADS" \
            --safe \
            -pre "$OUT_DIR/${GENE}_fixed" \
            -quiet \
    || { echo "âŒ $GENE è¿è¡Œå¤±è´¥ï¼Œè·³è¿‡"; continue; }

    echo "âœ… $GENE å®Œæˆ"
done

echo -e "\nğŸ¯ æ‰€æœ‰åŸºå› æ ‘å·²å‰ªæå¹¶é‡æ–°ä¼°åˆ†æ”¯é•¿åº¦ï¼Œç»“æœåœ¨ $OUT_DIR"





1) ç»™æ¯ä¸ªç›®å½•åšâ€œå¸¦åŸºå› åâ€çš„ .tre
æ ¸åŸºå› ï¼ˆä½ åŸºæœ¬å·²æœ‰ï¼‰ï¼š

bash
Copy
Edit
cd /mnt/spareHD_2/oxphos_gene_tree/pruned_trees

for f in $(ls *_fixed.treefile | sort); do
    gene=${f%%_*}
    printf '[%s]\n' "$gene"
    cat "$f"
    printf '\n'
done > /mnt/spareHD_2/oxphos_gene_tree/genes_astral_named.tre
çº¿ç²’ä½“åŸºå› ï¼ˆtop2 ç›®å½•ï¼‰ï¼š

bash
Copy
Edit
cd /mnt/spareHD_2/mt_gene_tree/pruned_trees_top2

for f in $(ls *_fixed.treefile | sort); do
    gene=${f%%_*}          # æ–‡ä»¶åå‰ç¼€ä½œä¸ºåŸºå› åï¼ˆATP6ã€ND1â€¦ï¼‰
    printf '[%s]\n' "$gene"
    cat "$f"
    printf '\n'
done > /mnt/spareHD_2/mt_gene_tree/mt_genes_named.tre
å¿«é€Ÿæ£€æŸ¥å„è‡ªåŒ…å«çš„æ ‘æ•°ï¼ˆ= åŸºå› æ•°ï¼‰ï¼š

bash
Copy
Edit
grep -c '^\[' /mnt/spareHD_2/oxphos_gene_tree/genes_astral_named.tre
grep -c '^\[' /mnt/spareHD_2/mt_gene_tree/mt_genes_named.tre
2) åˆå¹¶æ ¸ + çº¿ç²’ä½“ä¸ºä¸€ä¸ªå¤§ .tre
bash
Copy
Edit
cat \
  /mnt/spareHD_2/oxphos_gene_tree/genes_astral_named.tre \
  /mnt/spareHD_2/mt_gene_tree/mt_genes_named.tre \
  > /mnt/spareHD_2/all_genes_named.tre

# å†æ•°ä¸€ä¸‹æ€»å…±æœ‰å¤šå°‘æ£µæ ‘ï¼ˆåŸºå› ï¼‰
grep -c '^\[' /mnt/spareHD_2/all_genes_named.tre