#nulcear pi
/mnt/spareHD_2/nuclear/bed 




sed 's/^complex5_fixed/all_nuOXPHOS_fixed/' /work/cyu/poolseq/PPalign_output/fst/rename.txt \
  > /work/cyu/poolseq/PPalign_output/fst/rename_allnu.txt



cut -f1-3 /work/cyu/nuOXPHOS_genes_with_complex_core.bed \
  > /work/cyu/nuOXPHOS_genes_with_complex_core_clean.bed


grenedalf diversity \
  --sync-path /mnt/spareHD_2/nuclear/bed/all_nuOXPHOS_fixed.sync \
  --rename-samples-list /work/cyu/poolseq/PPalign_output/fst/rename_allnu.txt \
  --filter-sample-min-count 2 \
  --filter-sample-min-read-depth 4 \
  --window-type regions \
  --window-region-bed /work/cyu/nuOXPHOS_genes_with_complex_core_clean.bed \
  --window-average-policy valid-loci \
  --pool-sizes /work/cyu/poolseq/PPalign_output/fst/poolsize.txt \
  --out-dir /mnt/spareHD_2/nuclear/pi/pi_all_nuOXPHOS_corecomplex \
  --allow-file-overwriting




#!/usr/bin/env Rscript

library(data.table)
library(ggplot2)
library(tidyr)
library(dplyr)

# 1. 读取数据
df <- fread("diversity.csv")

# 2. 选取所有 .theta_pi 列
pi_cols <- grep("\\.theta_pi$", names(df), value = TRUE)

# 3. 提取种群名称
pop_names <- gsub("\\.theta_pi$", "", pi_cols)

# 4. 构造长格式数据框
pi_long <- df[, ..pi_cols]
pi_long <- setNames(pi_long, pop_names)
pi_long <- pivot_longer(pi_long, cols = everything(), names_to = "Population", values_to = "pi")

# 5. 去除 NA
pi_long <- na.omit(pi_long)

# 6. 绘制 boxplot
ggplot(pi_long, aes(x = Population, y = pi)) +
  geom_boxplot(outlier.size = 0.5, fill = "#2b7bba", alpha = 0.6) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylab("Nucleotide Diversity (π)") +
  xlab("Population") +
  ggtitle("π across OXPHOS core genes") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05)))

# 7. 保存
ggsave("pi_boxplot.pdf", width = 10, height = 6)





# 加载库
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)

# 读取注释好的多样性文件
df <- read_csv("diversity_annotated.csv")

# 提取所有 population 的列名（以 `.theta_pi` 结尾）
pi_cols <- grep("\\.theta_pi$", names(df), value = TRUE)

# 提取种群名
populations <- gsub("\\.theta_pi$", "", pi_cols)

# 选择感兴趣的列
df_long <- df %>%
  select(gene, complex, all_of(pi_cols)) %>%
  pivot_longer(cols = all_of(pi_cols), names_to = "Population", values_to = "Pi") %>%
  mutate(Population = gsub("\\.theta_pi", "", Population))

# 去除 NA
df_long <- df_long %>% filter(!is.na(Pi))

# 画图
p <- ggplot(df_long, aes(x = Population, y = Pi, fill = complex)) +
  geom_boxplot(outlier.size = 0.5, width = 0.6, position = position_dodge(width = 0.8)) +
  scale_fill_brewer(palette = "Set2") +
  labs(title = "Nucleotide Diversity (π) per Complex across Populations (Nuclear OXPHOS)",
       x = "Population", y = "Nucleotide Diversity (π)", fill = "Complex") +
  theme_bw(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "right")

# 保存图像
ggsave("pi_nuclear_complex_boxplot.pdf", p, width = 12, height = 6)

print("✅ Nuclear OXPHOS boxplot saved as pi_nuclear_complex_boxplot.pdf")
